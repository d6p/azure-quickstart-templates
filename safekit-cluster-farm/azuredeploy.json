{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"OS": {
			"type": "string",
			"metadata": {
				"description": "Operating System to install"
			},
			"defaultValue": "2016-Datacenter",
			"allowedValues": [
				"2016-Datacenter",
				"Linux CentOS"
			]
		},
		"clusterNodes": {
			"type": "int",
			"metadata": {
				"description": "number of VM nodes to create"
			},
			"defaultValue": 2,
			"allowedValues": [
				2,
				3,
				4
			]
		},
		"vmSize": {
			"type": "string",
			"metadata": {
				"description": "the VM size for all nodes"
			},
			"defaultValue": "Standard_A2_v2"
		},
		"adminUser": {
			"type": "string",
			"metadata": {
				"description": "User for the Virtual Machines."
			}
		},
		"adminPassword": {
			"type": "securestring",
			"metadata": {
				"description": "Password for the Virtual Machines."
			}
		},
		"VIPDnsLabel": {
			"type": "string",
			"metadata": {
				"description": "Public VIP dns label."
			},
			"defaultValue": "[concat(resourceGroup().name,'vip')]"
		},
		"azurePwsh": {
			"type": "string",
			"metadata": {
				"description": "install azure powershell module (optional)"
			},
			"defaultValue": "no",
			"allowedValues": [
				"yes",
				"no"
			]
		},
		"location": {
			"type": "string",
			"metadata": {
				"description": "resources location"
			},
			"defaultValue": "[resourceGroup().location]"
		},
		"safekitFileUri": {
			"type": "string",
			"metadata": {
				"description": "url of SafeKit package (optional, default to the appropriate Evidian website url)."
			},
			"defaultValue": "default"
		},
		"_artifactsLocation": {
			"type": "string",
			"metadata": {
				"description": "base URL of deployment resources (template,subtemplates,scripts)"
			},
			"defaultValue": "[deployment().properties.templateLink.uri]"
		},
		"_artifactsLocationSasToken": {
			"type": "securestring",
			"metadata": {
				"description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated. Use the defaultValue if the staging location is not secured."
			},
			"defaultValue": ""
		}
	},
	"variables": {
		"clusternodes": "[parameters('clusterNodes')]",
		"vmname": "VM1",
		"moduleName": "farm",
		"cltemplate": "[uri(parameters('_artifactsLocation'),'nestedtemplates/cluster.json')]",
		"ostype": "[if(equals(parameters('OS'), 'Linux CentOS'),'linux','windows')]",
		"adminUsername": "[if(empty(parameters('adminUser')),concat('admin',resourceGroup().name),parameters('adminUser'))]",
		"skcfgmoduletemplate": "[concat(uri(parameters('_artifactsLocation'),'nestedtemplates/cfgFarm.json'),parameters('_artifactsLocationSasToken'))]",
		"safekitpkgUrl": {
			"windows": "https://support.evidian.com/solutions/downloads/safekit/version_7.3/platforms/windows/beta_versions/safekit_windows_x86_64_7_4_0_0.msi",
			"linux": "https://support.evidian.com/solutions/downloads/safekit/version_7.3/platforms/linux/beta_versions/safekit_x86_64_7_4_0_0.bin"
		},
		"farmUrl": {
			"windows": "https://support.evidian.com/solutions/downloads/safekit/version_7.3/application_modules/windows/farm.safe",
			"linux": "https://support.evidian.com/solutions/downloads/safekit/version_7.3/application_modules/linux/farm.safe"
		}
	},
	"resources": [
		{
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2018-05-01",
			"name": "safekitCluster",
			"properties": {
				"mode": "Incremental",
				"templateLink": {
					"uri": "[variables('cltemplate')]",
					"contentVersion": "1.0.0.0"
				},
				"parameters": {
					"OS": {
						"value": "[parameters('OS')]"
					},
					"clusterNodes": {
						"value": "[variables('clusterNodes')]"
					},
					"vmSize": {
						"value": "[parameters('vmSize')]"
					},
					"adminUser": {
						"value": "[parameters('adminUser')]"
					},
					"adminPassword": {
						"value": "[parameters('adminPassword')]"
					},
					"moduleUrl": {
						"value": "[variables('farmUrl')[variables('ostype')]]"
					},
					"moduleName": {
						"value": "[variables('moduleName')]"
					},
					"VIPDnsLabel": {
						"value": "[parameters('VIPDnsLabel')]"
					},
					"Loadbalancer": {
						"value": "External"
					},
					"location": {
						"value": "[parameters('location')]"
					},
					"safekitFileUri": {
						"value": "[if(equals(parameters('safekitFileUri'),'default'),variables('safekitpkgUrl')[variables('ostype')],parameters('safekitFileUri'))]"
					},
					"_artifactsLocation": {
						"value": "[parameters('_artifactsLocation')]"
					},
					"_artifactsLocationSasToken": {
						"value": "[parameters('_artifactsLocationSasToken')]"
					}
				}
			}
		},
		{
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2018-05-01",
			"name": "safekitModuleConfig",
			"dependsOn": [
				"safekitCluster"
			],
			"properties": {
				"mode": "Incremental",
				"templateLink": {
					"uri": "[variables('skcfgmoduletemplate')]",
					"contentVersion": "1.0.0.0"
				},
				"parameters": {
					"vmname": {
						"value": "[variables('vmname')]"
					},
					"ostype": {
						"value": "[variables('ostype')]"
					},
					"moduleName": {
						"value": "[variables('moduleName')]"
					},
					"location": {
						"value": "[parameters('location')]"
					},
					"_artifactsLocation": {
						"value": "[parameters('_artifactsLocation')]"
					},
					"_artifactsLocationSasToken": {
						"value": "[parameters('_artifactsLocationSasToken')]"
					}
				}
			}
		}
	],
	"outputs": {
		"adminUser": {
			"type": "string",
			"value": "[variables('adminUserName')]"
		},
		"fqdn": {
			"type": "string",
			"value": "[reference('safekitCluster').outputs.fqdn.value]"
		},
		"Credentials Url": {
			"type": "string",
			"value": "[reference('safekitCluster').outputs['Credentials Url'].value]"
		},
		"Credentials Url Login": {
			"type": "string",
			"value": "[reference('safekitCluster').outputs['Credentials Url Login'].value]"
		},
		"Console Url": {
			"type": "string",
			"value": "[reference('safekitCluster').outputs['Console Url'].value]"
		},
		"Mosaic URL": {
			"type": "string",
			"value": "[reference('safekitCluster').outputs['Mosaic URL'].value]"
		}
	}
}